---
title: "è³ªçš„ãƒ‡ãƒ¼ã‚¿ã®å‡ºç¾é »åº¦"
jupyter: python3
author: "Ryo Nakagami"
date: "2025-04-14"
date-modified: last-modified
comments:
    utterances:
         repo: RyoNakagami/statistics-for-regression-monkey
         label: discussion
# when you run this file locally, do not forget to run poetry shell
---

## å•é¡Œè¨­å®š

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚«ãƒ†ã‚´ãƒªåˆ¥å‡ºç¾é »åº¦ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸ãˆã‚‰ã‚ŒãŸã¨ã—ã¾ã™ï¼

- `faulty_component`: æ•…éšœç®‡æ‰€
- `faulty_category`: æ•…éšœå†…å®¹ã«å¿œã˜ãŸåˆ†é¡
- `count`: å‡ºç¾é »åº¦

```{python}
import pandas as pd


data = {
    "faulty_component": [
        "ãƒãƒ¼ãƒ‰ãƒ‡ã‚£ã‚¹ã‚¯", "ãƒãƒ¼ãƒ‰ãƒ‡ã‚£ã‚¹ã‚¯",
        "ãƒ¡ãƒ¢ãƒª", "ãƒ¡ãƒ¢ãƒª",
        "é›»æºãƒ¦ãƒ‹ãƒƒãƒˆ", "é›»æºãƒ¦ãƒ‹ãƒƒãƒˆ",
        "ãƒ•ã‚¡ãƒ³", "ãƒã‚¶ãƒ¼ãƒœãƒ¼ãƒ‰",
        "æ¶²æ™¶ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤", "æ¶²æ™¶ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤",
        "ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢", "ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢"
    ],
    "faulty_category": [
        "æ¥ç¶šä¸è‰¯", "ç•°éŸ³",
        "èµ·å‹•ä¸è‰¯", "ãƒ–ãƒ«ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³",
        "é›»æºä¸å®‰å®š", "é›»æºä¸è‰¯",
        "ç•°éŸ³", "æ¥ç¶šä¸è‰¯",
        "ç”»é¢ä¸èªè­˜", "è¡¨ç¤ºãƒˆãƒ©ãƒ–ãƒ«",
        "èµ·å‹•æ™‚ã‚¨ãƒ©ãƒ¼", "ã‚¢ãƒ—ãƒªå¼·åˆ¶çµ‚äº†"
    ],
    "count": [125, 87, 73, 52, 64, 91, 40, 38, 70, 33, 49, 58]
}

df = pd.DataFrame(data)
df
```

<strong > &#9654;&nbsp; å¯è¦–åŒ–å†…å®¹</strong>

1. è¤‡æ•°ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°ã‚’çµåˆã—ã¦ç”Ÿæˆã—ãŸãƒ©ãƒ™ãƒ«å¤‰æ•°ã‚’keyï¼Œå‡ºç¾é »åº¦ã‚’valueã¨ã—ãŸãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ï¼Œå‡ºç¾é »åº¦ã‚’bar plot, ç´¯ç©é »åº¦ã‚’line plotã¨ã—ã¦å¯è¦–åŒ–
2. 2ã¤ã®ã‚«ãƒ†ã‚´ãƒªæ¬¡å…ƒã«ã‚ãŸã‚‹å€¤ã®é »åº¦åˆ†å¸ƒã‚’heatmapã‚’ç”¨ã„ã¦å¯è¦–åŒ–

## å¯è¦–åŒ–æ–¹é‡1: bar plot + line plot

<strong > &#9654;&nbsp; å‰å‡¦ç†</strong>

å‡ºç¾é »åº¦ã®ã‚«ãƒ©ãƒ ã‚’ç”¨ã„ã¦äº‹å‰ã« `descending sort` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿæ–½ã—ã¾ã™ï¼


```{python}
#| code-fold: show
df_sorted = df.sort_values(by="count", ascending=False).reset_index(drop=True)
df_sorted["cum_percent"] = df_sorted["count"].cumsum() / df_sorted["count"].sum()
df_sorted["label"] = df_sorted["faulty_component"].astype(str) + "-" + df_sorted["faulty_category"].astype(str)
df_sorted.head()
```

<br>
<strong > &#9654;&nbsp; å¼•æ•°ãƒ†ãƒ¼ãƒ–ãƒ«</strong>

|å¼•æ•°|èª¬æ˜|
|---|---|
|`data`|ã‚«ãƒ†ã‚´ãƒªï¼Œä»¶æ•°ï¼Œç´¯ç©å€¤ã‚’å«ã‚€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼cumulative plotãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã«ã¯ï¼Œãƒ‡ãƒ¼ã‚¿ãŒé©åˆ‡ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹|
|`category_column`| xè»¸ã«ä½¿ç”¨ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªåˆ—ã®åå‰|
|`count_column`| æ£’ã‚°ãƒ©ãƒ•ï¼ˆä¸»è»¸ï¼‰ã«ä½¿ç”¨ã™ã‚‹ä»¶æ•°åˆ—ã®åå‰|
|`cumulative_column`|line plot(y2-axis)ã«ä½¿ç”¨ã™ã‚‹ç´¯ç©å€¤ï¼ˆä¾‹ï¼šãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼‰ã®åˆ—ã®åå‰|
|`xaxis_name`| : xè»¸ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `""`|
|`y1_axis_name`| `y1-axis`ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `""`|
|`y2_axis_name`| `y2-axis`ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `""`|
|`y1_label`| bar plotã®legendãƒ©ãƒ™ãƒ«ï¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `""`|
|`y2_label`| cumulative plotã®legendãƒ©ãƒ™ãƒ«ï¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `""`|
|`figure_title`| å›³å…¨ä½“ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `""`|
|`figsize`|`matplotlib`ç”¨ã®figure sizeè¨­å®šå€¤(`tuple`)|

: Args {tbl-colwidths="[20, 80]"}

<br>
<strong > &#9654;&nbsp; `Plotly` ã‚’ç”¨ã„ãŸå¯è¦–åŒ–</strong>


```{python}
# | code-fold: show
import plotly.graph_objects as go


def plot_category_frequency_plotly(
    data: pd.DataFrame,
    category_column: str,
    count_column: str,
    cumulative_column: str,
    xaxis_name: str = "",
    y1_axis_name: str = "",
    y2_axis_name: str = "",
    y1_label: str = "",
    y2_label: str = "",
    figure_title: str = "",
) -> go.Figure:
    """
    - ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®ä»¶æ•°ã‚’æ£’ã‚°ãƒ©ãƒ•ã§ã€ç´¯ç©å€¤ï¼ˆä¾‹ï¼šç´¯ç©ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼‰ã‚’æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã§å¯è¦–åŒ–ã™ã‚‹Plotlyå›³ã‚’ç”Ÿæˆ
    - cumulative plotãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã«ã¯ï¼Œãƒ‡ãƒ¼ã‚¿ãŒé©åˆ‡ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹
    """
    # create bar trace
    bar = go.Bar(
        x=data[category_column],
        y=data[count_column],
        name=y1_label,
        yaxis="y1",
        marker=dict(color="#6699CC"),
    )

    # Create cumulative line trace
    line = go.Scatter(
        x=data[category_column],
        y=df_sorted[cumulative_column],
        name=y2_label,
        yaxis="y2",
        mode="lines+markers",
        line=dict(color="#000000", dash="dot"),
    )

    # Layout
    layout = go.Layout(
        title=dict(
            text=figure_title,
            x=0.,
            xanchor="left",
            yanchor="top",
        ),
        margin=dict(t=50),
        xaxis=dict(title=xaxis_name, tickangle=45),
        yaxis=dict(title=y1_axis_name),
        yaxis2=dict(
            title=y2_axis_name,
            overlaying="y",
            side="right",
            range=[0, 1.1],
            gridcolor="#EFF5F5",
        ),
        legend=dict(x=1.05, y=1.0, orientation="v"),
    )

    # Plot
    fig = go.Figure(data=[bar, line], layout=layout).update_layout(
        {"plot_bgcolor": "#EFF5F5", "yaxis": {"gridcolor": "#EFF5F5"}}
    )

    return fig
```

å®Ÿè¡Œã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ï¼Œ

```{python}
#| code-fold: show
fig = plot_category_frequency_plotly(
    data=df_sorted,
    category_column="label",
    count_column="count",
    cumulative_column="cum_percent",
    xaxis_name="Faulty Category",
    y1_axis_name="Frequency",
    y2_axis_name="Cumulative Percentage",
    y1_label="ä»¶æ•°",
    y2_label="ç´¯ç©å‰²åˆ",
    figure_title="PC Faulty component frequency",
)
fig.show()
```

<br>
<strong > &#9654;&nbsp; `matplotlib` ã‚’ç”¨ã„ãŸå¯è¦–åŒ–</strong>

```{python}
#| code-fold: show
import matplotlib.pyplot as plt


def plot_category_frequency_matplotlib(
    data: pd.DataFrame,
    category_column: str,
    count_column: str,
    cumulative_column: str,
    xaxis_name: str = "",
    y1_axis_name: str = "",
    y2_axis_name: str = "",
    y1_label: str = "",
    y2_label: str = "",
    figure_title: str = "",
    figsize: tuple = (8, 6),
):
    fig, ax1 = plt.subplots(figsize=figsize)
    ax1.set_facecolor("#EFF5F5")  # ğŸ‘ˆ plot background color

    # Bar plot on primary y-axis
    bars = ax1.bar(
        data[category_column], data[count_column], color="#6699CC", label=y1_label
    )
    ax1.set_ylabel(y1_axis_name, fontsize=12)
    ax1.set_xlabel(xaxis_name, fontsize=12)
    ax1.tick_params(axis="y")

    # Line plot on secondary y-axis
    ax2 = ax1.twinx()
    line = ax2.plot(
        data[category_column],
        data[cumulative_column],
        color="#000000",
        linestyle="dotted",
        marker="o",
        label=y2_label,
    )
    ax2.set_ylabel(y2_axis_name, fontsize=12)
    ax2.set_ylim(0, 1.1)
    ax2.tick_params(axis="y")
    plt.setp(ax1.get_xticklabels(), rotation=(360-45), ha="left")  # ğŸ‘ˆ Rotate x-axis labels
    
    # Title and legend
    fig.suptitle(figure_title, x=0.0, ha="left", fontsize=14)

    # Combine legends from both axes
    lines_labels = [*ax1.get_legend_handles_labels(), *ax2.get_legend_handles_labels()]
    fig.legend(loc="upper left", bbox_to_anchor=(0.925, 0.925))
    fig.patch.set_facecolor("#FFFFFF")

    plt.tight_layout()
    return fig, ax1, ax2

```

å®Ÿè¡Œã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ï¼Œ

```{python}
# | code-fold: show

from regmonkey_style import stylewizard as sw

# japanese language setup
sw.set_font("IPAexGothic")


fig, ax1, ax2 = plot_category_frequency_matplotlib(
    data=df_sorted,
    category_column="label",
    count_column="count",
    cumulative_column="cum_percent",
    xaxis_name="Faulty Category",
    y1_axis_name="Frequency",
    y2_axis_name="Cumulative Percentage",
    y1_label="ä»¶æ•°",
    y2_label="ç´¯ç©å‰²åˆ",
    figure_title="PC Faulty component frequency",
)
plt.show()
```

## å¯è¦–åŒ–æ–¹é‡2: heatmap

- ã“ã“ã§ã¯ï¼Œxaxis, yaxisã¨ãªã‚‹ï¼’ã¤ã®ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°ã‚’ç”¨ã„ã¦pivot tableã‚’ä½œæˆã—ï¼Œãã‚Œã‚’heatmapã§å¯è¦–åŒ–
- pivotã«ã‚ãŸã£ã¦ã®é›†è¨ˆé–¢æ•°ã¯ `sum` ã‚’ç”¨ã„ã‚‹
- `NaN`ï¼ˆæ¬ æå€¤ï¼‰ã¯ãƒ—ãƒ­ãƒƒãƒˆå‰ã«0ã§è£œå®Œ
- `"PuBu"` ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ä½¿ç”¨

<strong > &#9654;&nbsp; å®Ÿè£…</strong>

```{python}
# | code-fold: show
import seaborn as sns


def heatmap_frequency(
    data: pd.DataFrame,
    xaxis_column: str,
    yaxis_column: str,
    value_column: str,
    x_axis_name: str = "",
    y_axis_name: str = "",
    figure_title: str = "",
    plot_type = 'plotly',
    figsize = (10, 6)
):
    table = pd.pivot_table(
        df_sorted,
        values=value_column,
        index=[yaxis_column],
        columns=[xaxis_column],
        aggfunc="sum",
    ).fillna(0)

    if plot_type == 'plotly':
        fig = go.Figure(
            data=go.Heatmap(
                z=table.values,
                x=table.columns,  # Optional: x-axis labels
                y=table.index,  # Optional: y-axis labels
                colorscale="PuBu",  # You can try: 'Blues', 'Hot', 'Cividis', etc.
            )
        )

        fig.update_layout(
            title=figure_title, xaxis_title=x_axis_name, yaxis_title=y_axis_name
            
        )

        return fig
    
    else:
         # Create the plot
        fig, ax = plt.subplots(figsize=figsize)

        sns.heatmap(
            table.values,
            xticklabels=table.columns,
            yticklabels=table.index,
            cmap="PuBu",
            ax=ax
        )

        ax.set_xlabel(x_axis_name)
        ax.set_ylabel(y_axis_name)
        ax.set_title(figure_title, loc="center")

        plt.xticks(rotation=(360-45), ha='left')
        plt.yticks(rotation=0)

        plt.tight_layout()
        return fig, ax

```

<strong > &#9654;&nbsp; `Plotly` ã«ã‚ˆã‚‹å¯è¦–åŒ–</strong>

```{python}
fig = heatmap_frequency(
    data=df_sorted,
    xaxis_column="faulty_category",
    yaxis_column="faulty_component",
    value_column="count",
    x_axis_name="æ•…éšœã‚«ãƒ†ã‚´ãƒª",
    y_axis_name="æ•…éšœç®‡æ‰€",
    figure_title=dict(
        text="æ•…éšœåˆ†å¸ƒ",
        font=dict(size=18),
        automargin=True,
        x=0.5,  # Center title
        y=0.95,
        xanchor="center",
    ),
)


fig.show()
```

<strong > &#9654;&nbsp; `matplotlib` ã«ã‚ˆã‚‹å¯è¦–åŒ–</strong>

```{python}
fig, ax = heatmap_frequency(
    data=df_sorted,
    xaxis_column='faulty_category',
    yaxis_column='faulty_component',
    value_column='count',
    x_axis_name='æ•…éšœã‚«ãƒ†ã‚´ãƒª',
    y_axis_name='æ•…éšœç®‡æ‰€',
    figure_title='æ•…éšœåˆ†å¸ƒ',
    plot_type = 'matplotlib',
)

plt.show()
```